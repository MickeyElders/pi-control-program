<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Water Pump Control</title>
    <link rel="stylesheet" href="static/style.css" />
  </head>
  <body>
    <div class="scale-wrap">
      <div class="scale-root">
        <main class="stage">
          <div class="panel-wrap">
            <section class="panel" aria-live="polite">
        {% set routes = ["清水桶 → 浸泡桶", "加热桶 → 浸泡桶"] %}
        {% set pump3 = pumps[2] if pumps | length > 2 else None %}
        <header class="panel-header">
          <div>
            <p class="eyebrow">Relay Deck</p>
            <h1>PID水循环控制</h1>
          </div>
          <div class="header-actions">
            <button class="btn debug-toggle" id="debug-toggle" type="button">调试模式</button>
          </div>
          <div class="meta">
            <div class="heater-panel header-heater">
              <div class="heater-status" id="heater-status">
                {% if heater.configured %}
                加热状态：<span data-role="heater-text">{{ "开启" if heater.on else "关闭" }}</span>
                {% else %}
                加热状态：未配置
                {% endif %}
              </div>
              <button
                class="btn toggle heater-toggle"
                id="heater-toggle"
                type="button"
                {% if not heater.configured %}disabled{% endif %}
              >
                {{ "停止加热" if heater.on else "开始加热" }}
              </button>
            </div>
          </div>
        </header>
        <div class="tank-row">
          <div class="lift-panel">
            <div class="lift-status" id="lift-status">已停止</div>
            <div class="lift-controls">
              <button class="btn lift-up" id="lift-up" type="button">升高</button>
              <button class="btn lift-down" id="lift-down" type="button">下降</button>
              <button class="btn lift-stop" id="lift-stop" type="button">停止</button>
            </div>
          </div>
          <div class="tank soak" style="--level: {{ tank_levels.soak }}; --liquid-base: {{ tank_colors.soak[0] }} {{ tank_colors.soak[1] }} {{ tank_colors.soak[2] }}">
            <div class="tank-body">
              <div class="lift-rail" aria-hidden="true">
                <div class="lift-carriage">
                  <div class="lift-indicator" id="lift-indicator">
                    <div class="arrow up"></div>
                    <div class="arrow down"></div>
                  </div>
                </div>
              </div>
              <div class="tank-percent">{{ tank_levels.soak }}%</div>
              <div class="tank-metrics">
                <span>温度 {{ "%.1f"|format(tank_temps.soak) }}°C</span>
                <span>pH {{ "%.2f"|format(tank_phs.soak) }}</span>
              </div>
              <div class="tank-liquid">
                <div class="surface"></div>
                <div class="surface two"></div>
              </div>
            </div>
            <div class="tank-label">浸泡桶</div>
          </div>
          <div class="pipe-column" aria-hidden="true">
            <div class="pipe-group fresh">
              <div class="pipe to-left" data-pipe="0"><div class="pipe-flow"></div></div>
              <div class="pipe to-right" data-pipe="1"><div class="pipe-flow"></div></div>
            </div>
            <div class="pipe-group heat">
              <div class="pipe to-left" data-pipe="2"><div class="pipe-flow"></div></div>
              <div class="pipe to-right" data-pipe="3"><div class="pipe-flow"></div></div>
            </div>
          </div>
          <div class="tank-stack">
            <div class="tank small fresh" style="--level: {{ tank_levels.fresh }}; --liquid-base: {{ tank_colors.fresh[0] }} {{ tank_colors.fresh[1] }} {{ tank_colors.fresh[2] }}">
              <div class="tank-body">
                <div class="tank-percent">{{ tank_levels.fresh }}%</div>
                <div class="tank-metrics">
                  <span>温度 {{ "%.1f"|format(tank_temps.fresh) }}°C</span>
                  <span>pH {{ "%.2f"|format(tank_phs.fresh) }}</span>
                </div>
                <div class="tank-liquid">
                  <div class="surface"></div>
                  <div class="surface two"></div>
                </div>
              </div>
              <div class="tank-label">清水桶</div>
            </div>
            <div class="tank small heat" style="--level: {{ tank_levels.heat }}; --liquid-base: {{ tank_colors.heat[0] }} {{ tank_colors.heat[1] }} {{ tank_colors.heat[2] }}">
              <div class="tank-body">
                <div class="tank-percent">{{ tank_levels.heat }}%</div>
                <div class="tank-metrics">
                  <span>温度 {{ "%.1f"|format(tank_temps.heat) }}°C</span>
                  <span>pH {{ "%.2f"|format(tank_phs.heat) }}</span>
                </div>
                <div class="tank-liquid">
                  <div class="surface"></div>
                  <div class="surface two"></div>
                </div>
              </div>
              <div class="tank-label">加热桶</div>
            </div>
          </div>
        </div>

        <div class="grid" id="grid">
          {% for pump in pumps %}
          {% if pump.index < 2 %}
          <article
            class="pump-card{% if pump.on %} on{% endif %}"
            data-kind="pump"
            data-index="{{ pump.index }}"
            data-on="{{ "1" if pump.on else "0" }}"
          >
            <div class="pump-top">
              <div class="pump-icon" aria-hidden="true">
                <div class="pump-shell"></div>
                <div class="pump-center"></div>
                <div class="pump-spout"></div>
                <div class="water"></div>
              </div>
              <div class="pump-label">
                <h2>{{ pump.index + 1 }}号水泵</h2>
                <p class="pump-route">
                  {{ routes[pump.index] if pump.index < routes | length else "未配置" }}
                </p>
                <p class="pump-meta">GPIO <span class="mono">{{ pump.pin }}</span></p>
              </div>
            </div>

            <div class="status">
              <span class="dot" data-role="dot"></span>
              <span class="status-text" data-role="status">关闭</span>
            </div>

            <div class="controls">
              <button class="btn toggle" data-role="toggle" type="button">打开</button>
            </div>
          </article>
          {% endif %}
          {% endfor %}

          <article
            class="pump-card{% if pump3 and pump3.on %} on{% endif %}"
            data-kind="pump"
            data-index="2"
            data-on="{{ "1" if pump3 and pump3.on else "0" }}"
          >
            <div class="pump-top pump-top-split">
              <div class="pump-info-block">
                <div class="pump-icon" aria-hidden="true">
                  <div class="pump-shell"></div>
                  <div class="pump-center"></div>
                  <div class="pump-spout"></div>
                  <div class="water"></div>
                </div>
                <div class="pump-label">
                  <div class="pump-title-row">
                    <h2>3号水泵</h2>
                    <span class="status-chip">
                      <span class="dot" data-role="dot"></span>
                      <span class="status-text" data-role="status">关闭</span>
                    </span>
                  </div>
                  <p class="pump-route">浸泡桶 → 自动阀</p>
                  {% if pump3 %}
                  <p class="pump-meta">GPIO <span class="mono">{{ pump3.pin }}</span></p>
                  {% endif %}
                </div>
              </div>
              <div class="auto-switches compact inline">
                <div class="auto-row" data-auto="fresh" data-on="{{ "1" if auto_switches.fresh else "0" }}">
                  <div class="auto-text">
                    <div class="auto-title">开关1</div>
                    <div class="auto-sub">浸泡桶 → 清水桶</div>
                  </div>
                  <button class="btn toggle auto" data-auto="fresh" type="button">打开</button>
                </div>
                <div class="auto-row" data-auto="heat" data-on="{{ "1" if auto_switches.heat else "0" }}">
                  <div class="auto-text">
                    <div class="auto-title">开关2</div>
                    <div class="auto-sub">浸泡桶 → 加热桶</div>
                  </div>
                  <button class="btn toggle auto" data-auto="heat" type="button">打开</button>
                </div>
              </div>
            </div>

            <div class="controls">
              <button class="btn toggle" data-role="toggle" type="button">打开</button>
            </div>
          </article>
        </div>

        <p class="hint" id="hint">就绪。</p>
            </section>
          </div>
        </main>
      </div>
    </div>

    <script>
      const pumpCards = Array.from(document.querySelectorAll('.pump-card[data-kind="pump"]'));
      const pump3Card = document.querySelector('.pump-card[data-index="2"]');
      const autoRows = Array.from(document.querySelectorAll(".auto-row"));
      const hint = document.getElementById("hint");
      const API_BASE =
        window.API_BASE || new URLSearchParams(window.location.search).get("api") || "";
      const api = (path) =>
        API_BASE ? API_BASE.replace(/\/$/, "") + path : path;
      const pipes = new Map(
        Array.from(document.querySelectorAll(".pipe")).map((pipe) => [
          pipe.dataset.pipe,
          pipe,
        ])
      );
      const liftIndicator = document.getElementById("lift-indicator");
      const liftStatus = document.getElementById("lift-status");
      const liftUp = document.getElementById("lift-up");
      const liftDown = document.getElementById("lift-down");
      const liftStop = document.getElementById("lift-stop");
      const debugToggle = document.getElementById("debug-toggle");
      const heaterToggle = document.getElementById("heater-toggle");
      const heaterText = document.querySelector('[data-role="heater-text"]');

      function isMobileDevice() {
        const ua = navigator.userAgent || "";
        const uaData = navigator.userAgentData;
        if (uaData && typeof uaData.mobile === "boolean") {
          return uaData.mobile;
        }
        return /Android|iPhone|iPad|iPod|Mobile|Windows Phone/i.test(ua);
      }

      function updateViewportClass() {
        document.body.classList.toggle("is-mobile", isMobileDevice());
      }

      function updatePanelScale() {
        const root = document.querySelector(".scale-root");
        const wrap = document.querySelector(".scale-wrap");
        if (!root || !wrap) return;
        if (!document.body.classList.contains("is-mobile")) {
          root.style.removeProperty("--scale");
          root.style.removeProperty("--stretch");
          wrap.style.removeProperty("height");
          return;
        }
        requestAnimationFrame(() => {
          const baseWidth = 920;
          const baseHeight = root.scrollHeight || root.offsetHeight;
          if (!baseHeight) return;
          const viewportHeight = window.visualViewport?.height || window.innerHeight;
          const scaleX = Math.min(1, window.innerWidth / baseWidth);
          const scale = scaleX;
          root.style.setProperty("--scale", scale.toFixed(3));

          const scaledHeight = baseHeight * scale;
          const stretch = Math.min(1.2, Math.max(1, viewportHeight / scaledHeight));
          root.style.setProperty("--stretch", stretch.toFixed(3));
          wrap.style.height = `${scaledHeight * stretch}px`;
        });
      }

      updateViewportClass();
      updatePanelScale();

      window.addEventListener("resize", () => {
        updateViewportClass();
        updatePanelScale();
      });

      window.addEventListener("load", () => {
        updateViewportClass();
        updatePanelScale();
      });

      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", updatePanelScale);
      }

      function setPipeFlow(index, on) {
        const pipe = pipes.get(String(index));
        if (pipe) {
          pipe.classList.toggle("on", on);
        }
      }

      function setPumpStatus(card, on) {
        const dot = card.querySelector('[data-role="dot"]');
        const label = card.querySelector('[data-role="status"]');
        const toggle = card.querySelector('[data-role="toggle"]');
        label.textContent = on ? "开启" : "关闭";
        dot.classList.toggle("on", on);
        dot.classList.toggle("off", !on);
        card.classList.toggle("on", on);
        card.dataset.on = on ? "1" : "0";
        toggle.textContent = on ? "关闭" : "打开";
        toggle.classList.toggle("on", !on);
        toggle.classList.toggle("off", on);
        const index = Number(card.dataset.index);
        if (index === 0) {
          setPipeFlow(0, on);
        } else if (index === 1) {
          setPipeFlow(2, on);
        }
      }

      function setLiftState(state) {
        liftIndicator.classList.toggle("up", state === "up");
        liftIndicator.classList.toggle("down", state === "down");
        liftIndicator.classList.toggle("idle", state === "stop");
        if (state === "up") {
          liftStatus.textContent = "正在抬起";
        } else if (state === "down") {
          liftStatus.textContent = "正在降低";
        } else {
          liftStatus.textContent = "已停止";
        }
      }

      function setLiftButtonsDisabled(disabled) {
        [liftUp, liftDown, liftStop].forEach((btn) => {
          if (btn) btn.disabled = disabled;
        });
      }

      function setCardBusy(card, busy) {
        if (!card) return;
        card.querySelectorAll("button").forEach((btn) => {
          btn.disabled = busy;
        });
      }

      function updateValveFlows(pumpOn) {
        autoRows.forEach((row) => {
          const which = row.dataset.auto;
          const active = row.dataset.on === "1" && pumpOn;
          if (which === "fresh") {
            setPipeFlow(1, active);
          } else if (which === "heat") {
            setPipeFlow(3, active);
          }
        });
      }

      function setAutoRow(row, on) {
        row.dataset.on = on ? "1" : "0";
        const btn = row.querySelector("button");
        if (btn) {
          btn.textContent = on ? "关闭" : "打开";
          btn.classList.toggle("on", !on);
          btn.classList.toggle("off", on);
        }
      }

      function setPumpCardStatus(card, on) {
        if (!card) return;
        const dot = card.querySelector('[data-role="dot"]');
        const label = card.querySelector('[data-role="status"]');
        label.textContent = on ? "开启" : "关闭";
        dot.classList.toggle("on", on);
        dot.classList.toggle("off", !on);
        card.classList.toggle("on", on);
        card.dataset.on = on ? "1" : "0";
        const toggle = card.querySelector('[data-role="toggle"]');
        if (toggle) {
          toggle.textContent = on ? "关闭" : "打开";
          toggle.classList.toggle("on", !on);
          toggle.classList.toggle("off", on);
        }
      }

      async function refreshStatus() {
        try {
          const res = await fetch(api("/api/status"));
          const data = await res.json();
          const relayMap = new Map((data.relays || []).map((item) => [String(item.index), item]));
          pumpCards.forEach((card) => {
            const item = relayMap.get(card.dataset.index);
            if (item) {
              setPumpStatus(card, Boolean(item.on));
            }
          });
          if (data.relays && data.relays[2]) {
            setPumpCardStatus(pump3Card, Boolean(data.relays[2].on));
          }
          if (data.auto) {
            const autoConfigured = data.auto.configured !== false;
            autoRows.forEach((row) => {
              const which = row.dataset.auto;
              setAutoRow(row, Boolean(data.auto[which]));
              const btn = row.querySelector("button");
              if (btn) btn.disabled = !autoConfigured;
            });
          }
          if (data.heater && heaterToggle && heaterText) {
            const configured = Boolean(data.heater.configured);
            heaterToggle.disabled = !configured;
            if (configured) {
              const on = Boolean(data.heater.on);
              heaterText.textContent = on ? "开启" : "关闭";
              heaterToggle.textContent = on ? "停止加热" : "开始加热";
              heaterToggle.classList.toggle("on", !on);
              heaterToggle.classList.toggle("off", on);
            }
          }
          if (data.lift) {
            const configured = data.lift.configured !== false;
            setLiftButtonsDisabled(!configured);
            if (data.lift.state) {
              setLiftState(data.lift.state);
            }
          }
          updateValveFlows(pump3Card?.dataset.on === "1");
          hint.textContent = "Last update: " + new Date().toLocaleTimeString();
        } catch (err) {
          hint.textContent = "Status unavailable.";
        }
      }

      async function setRelay(card, on) {
        setCardBusy(card, true);
        hint.textContent = on ? "正在开启..." : "正在关闭...";
        const index = Number(card.dataset.index);
        try {
          const res = await fetch(api("/api/relay"), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ index, on }),
          });
          const data = await res.json();
          setPumpStatus(card, Boolean(data.on));
          hint.textContent = data.on ? "水泵已开启。" : "水泵已关闭。";
        } catch (err) {
          hint.textContent = "指令失败。";
        } finally {
          setCardBusy(card, false);
        }
      }

      async function setAutoSwitch(row, on) {
        setCardBusy(pump3Card, true);
        hint.textContent = on ? "正在开启..." : "正在关闭...";
        const which = row.dataset.auto;
        try {
          const res = await fetch(api("/api/auto"), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ which, on }),
          });
          const data = await res.json();
          if (data.auto) {
            autoRows.forEach((r) => {
              const key = r.dataset.auto;
              setAutoRow(r, Boolean(data.auto[key]));
            });
          }
          updateValveFlows(pump3Card?.dataset.on === "1");
          hint.textContent = "阀门状态已更新。";
        } catch (err) {
          hint.textContent = "指令失败。";
        } finally {
          setCardBusy(pump3Card, false);
        }
      }

      async function setLift(state) {
        setLiftButtonsDisabled(true);
        hint.textContent = "正在执行升降...";
        try {
          const res = await fetch(api("/api/lift"), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ state }),
          });
          const data = await res.json();
          if (data.state) {
            setLiftState(data.state);
          } else {
            setLiftState(state);
          }
          hint.textContent = "升降状态已更新。";
        } catch (err) {
          hint.textContent = "指令失败。";
        } finally {
          setLiftButtonsDisabled(false);
        }
      }

      pumpCards.forEach((card) => {
        const toggle = card.querySelector('[data-role="toggle"]');
        toggle.addEventListener("click", () => {
          const nextOn = card.dataset.on !== "1";
          setRelay(card, nextOn);
        });
        setPumpStatus(card, card.dataset.on === "1");
      });

      autoRows.forEach((row) => {
        const btn = row.querySelector("button");
        btn.addEventListener("click", () => {
          const nextOn = row.dataset.on !== "1";
          setAutoSwitch(row, nextOn);
        });
        setAutoRow(row, row.dataset.on === "1");
      });

      if (pump3Card) {
        setPumpCardStatus(pump3Card, pump3Card.dataset.on === "1");
      }
      updateValveFlows(pump3Card?.dataset.on === "1");

      liftUp.addEventListener("click", () => setLift("up"));
      liftDown.addEventListener("click", () => setLift("down"));
      liftStop.addEventListener("click", () => setLift("stop"));
      setLiftState("stop");

      debugToggle.addEventListener("click", () => {
        document.body.classList.toggle("debug");
        debugToggle.classList.toggle("active");
      });

      if (heaterToggle) {
        heaterToggle.addEventListener("click", async () => {
          if (heaterToggle.disabled) return;
          const nextOn = heaterText?.textContent !== "开启";
          try {
            const res = await fetch(api("/api/heater"), {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ on: nextOn }),
            });
            const data = await res.json();
            if (data.configured && heaterText) {
              const on = Boolean(data.on);
              heaterText.textContent = on ? "开启" : "关闭";
              heaterToggle.textContent = on ? "停止加热" : "开始加热";
            }
          } catch (err) {
            hint.textContent = "指令失败。";
          }
        });
      }

      refreshStatus();
      setInterval(refreshStatus, 1000);
    </script>
  </body>
</html>
