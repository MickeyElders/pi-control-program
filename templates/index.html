<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Water Pump Control</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <main class="stage">
      <section class="panel" aria-live="polite">
        {% set routes = ["清水桶 → 浸泡桶", "浸泡桶 → 清水桶", "加热桶 → 浸泡桶", "浸泡桶 → 加热桶"] %}
        <header class="panel-header">
          <div>
            <p class="eyebrow">Relay Deck</p>
            <h1>PID水循环控制</h1>
          </div>
          <div class="meta">
            <div class="meta-row">
              低电平触发: <span class="mono">{{ "true" if active_low else "false" }}</span>
            </div>
            <div class="meta-row">
              GPIO: <span class="mono">{{ pins | join(", ") }}</span>
            </div>
          </div>
        </header>
        <div class="tank-row">
          <div class="tank soak" style="--level: {{ tank_levels.soak }}">
            <div class="tank-body">
              <div class="lift-rail" aria-hidden="true">
                <div class="lift-carriage">
                  <div class="lift-indicator" id="lift-indicator">
                    <div class="arrow up"></div>
                    <div class="arrow down"></div>
                  </div>
                </div>
              </div>
              <div class="tank-percent">{{ tank_levels.soak }}%</div>
              <div class="tank-metrics">
                <span>温度 {{ "%.1f"|format(tank_temps.soak) }}°C</span>
                <span>pH {{ "%.2f"|format(tank_phs.soak) }}</span>
              </div>
              <div class="tank-liquid">
                <div class="surface"></div>
                <div class="surface two"></div>
              </div>
            </div>
            <div class="tank-label">浸泡桶</div>
            <div class="lift-panel">
              <div class="lift-status" id="lift-status">已停止</div>
              <div class="lift-controls">
                <button class="btn lift-up" id="lift-up" type="button">升高</button>
                <button class="btn lift-down" id="lift-down" type="button">下降</button>
                <button class="btn lift-stop" id="lift-stop" type="button">停止</button>
              </div>
            </div>
          </div>
          <div class="pipe-column" aria-hidden="true">
            <div class="pipe-group fresh">
              <div class="pipe to-left" data-pipe="0"><div class="pipe-flow"></div></div>
              <div class="pipe to-right" data-pipe="1"><div class="pipe-flow"></div></div>
            </div>
            <div class="pipe-group heat">
              <div class="pipe to-left" data-pipe="2"><div class="pipe-flow"></div></div>
              <div class="pipe to-right" data-pipe="3"><div class="pipe-flow"></div></div>
            </div>
          </div>
          <div class="tank-stack">
            <div class="tank small fresh" style="--level: {{ tank_levels.fresh }}">
              <div class="tank-body">
                <div class="tank-percent">{{ tank_levels.fresh }}%</div>
                <div class="tank-metrics">
                  <span>温度 {{ "%.1f"|format(tank_temps.fresh) }}°C</span>
                  <span>pH {{ "%.2f"|format(tank_phs.fresh) }}</span>
                </div>
                <div class="tank-liquid">
                  <div class="surface"></div>
                  <div class="surface two"></div>
                </div>
              </div>
              <div class="tank-label">清水桶</div>
            </div>
            <div class="tank small heat" style="--level: {{ tank_levels.heat }}">
              <div class="tank-body">
                <div class="tank-percent">{{ tank_levels.heat }}%</div>
                <div class="tank-metrics">
                  <span>温度 {{ "%.1f"|format(tank_temps.heat) }}°C</span>
                  <span>pH {{ "%.2f"|format(tank_phs.heat) }}</span>
                </div>
                <div class="tank-liquid">
                  <div class="surface"></div>
                  <div class="surface two"></div>
                </div>
              </div>
              <div class="tank-label">加热桶</div>
            </div>
          </div>
        </div>

        <div class="grid" id="grid">
          {% for pump in pumps %}
          <article
            class="pump-card{% if pump.on %} on{% endif %}"
            data-index="{{ pump.index }}"
            data-on="{{ "1" if pump.on else "0" }}"
          >
            <div class="pump-top">
              <div class="pump-icon" aria-hidden="true">
                <div class="pump-shell"></div>
                <div class="pump-center"></div>
                <div class="pump-spout"></div>
                <div class="water"></div>
              </div>
              <div class="pump-label">
                <h2>{{ pump.index + 1 }}号开关</h2>
                <p class="pump-route">
                  {{ routes[pump.index] if pump.index < routes | length else "未配置" }}
                </p>
                <p class="pump-meta">GPIO <span class="mono">{{ pump.pin }}</span></p>
              </div>
            </div>

            <div class="status">
              <span class="dot" data-role="dot"></span>
              <span class="status-text" data-role="status">关闭</span>
            </div>

            <div class="controls">
              <button class="btn toggle" data-role="toggle" type="button">打开</button>
            </div>
          </article>
          {% endfor %}
        </div>

        <p class="hint" id="hint">就绪。</p>
      </section>
    </main>

    <script>
      const cards = Array.from(document.querySelectorAll(".pump-card"));
      const hint = document.getElementById("hint");
      const pipes = new Map(
        Array.from(document.querySelectorAll(".pipe")).map((pipe) => [
          pipe.dataset.pipe,
          pipe,
        ])
      );
      const liftIndicator = document.getElementById("lift-indicator");
      const liftStatus = document.getElementById("lift-status");
      const liftUp = document.getElementById("lift-up");
      const liftDown = document.getElementById("lift-down");
      const liftStop = document.getElementById("lift-stop");

      function setPipeFlow(index, on) {
        const pipe = pipes.get(String(index));
        if (pipe) {
          pipe.classList.toggle("on", on);
        }
      }

      function setCardStatus(card, on) {
        const dot = card.querySelector('[data-role="dot"]');
        const label = card.querySelector('[data-role="status"]');
        const toggle = card.querySelector('[data-role="toggle"]');
        label.textContent = on ? "开启" : "关闭";
        dot.classList.toggle("on", on);
        dot.classList.toggle("off", !on);
        card.classList.toggle("on", on);
        card.dataset.on = on ? "1" : "0";
        toggle.textContent = on ? "关闭" : "打开";
        toggle.classList.toggle("on", !on);
        toggle.classList.toggle("off", on);
        setPipeFlow(card.dataset.index, on);
      }

      function setLiftState(state) {
        liftIndicator.classList.toggle("up", state === "up");
        liftIndicator.classList.toggle("down", state === "down");
        liftIndicator.classList.toggle("idle", state === "stop");
        if (state === "up") {
          liftStatus.textContent = "正在抬起";
        } else if (state === "down") {
          liftStatus.textContent = "正在降低";
        } else {
          liftStatus.textContent = "已停止";
        }
      }

      function setCardBusy(card, busy) {
        card.querySelectorAll("button").forEach((btn) => {
          btn.disabled = busy;
        });
      }

      async function refreshStatus() {
        try {
          const res = await fetch("/api/status");
          const data = await res.json();
          const relayMap = new Map(
            (data.relays || []).map((item) => [String(item.index), item])
          );
          cards.forEach((card) => {
            const item = relayMap.get(card.dataset.index);
            if (item) {
              setCardStatus(card, Boolean(item.on));
            }
          });
          hint.textContent = "Last update: " + new Date().toLocaleTimeString();
        } catch (err) {
          hint.textContent = "Status unavailable.";
        }
      }

      async function setRelay(card, on) {
        setCardBusy(card, true);
        hint.textContent = on ? "正在开启..." : "正在关闭...";
        const index = Number(card.dataset.index);
        try {
          const res = await fetch("/api/relay", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ index, on }),
          });
          const data = await res.json();
          setCardStatus(card, Boolean(data.on));
          hint.textContent = data.on ? "水泵已开启。" : "水泵已关闭。";
        } catch (err) {
          hint.textContent = "指令失败。";
        } finally {
          setCardBusy(card, false);
        }
      }

      cards.forEach((card) => {
        const toggle = card.querySelector('[data-role="toggle"]');
        toggle.addEventListener("click", () => {
          const nextOn = card.dataset.on !== "1";
          setRelay(card, nextOn);
        });
        setCardStatus(card, card.dataset.on === "1");
      });

      liftUp.addEventListener("click", () => setLiftState("up"));
      liftDown.addEventListener("click", () => setLiftState("down"));
      liftStop.addEventListener("click", () => setLiftState("stop"));
      setLiftState("stop");

      refreshStatus();
      setInterval(refreshStatus, 1000);
    </script>
  </body>
</html>
