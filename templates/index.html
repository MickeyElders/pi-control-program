<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PID水循环控制</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="dashboard">
      {% set routes = ["清水桶 → 浸泡桶", "加热桶 → 浸泡桶"] %}
      {% set pump3 = pumps[2] if pumps | length > 2 else None %}
      <header class="topbar">
        <div class="title-block">
          <p class="badge">RELAY DECK</p>
          <h1>PID水循环控制</h1>
          <p class="subtitle">Industrial Flow Orchestration</p>
        </div>
        <div class="top-actions">
          <div class="meta">
            <div>低电平触发：<span class="mono">{{ "true" if active_low else "false" }}</span></div>
            <div>GPIO：<span class="mono">{{ pins | join(", ") }}</span></div>
          </div>
          <button class="btn ghost" id="debug-toggle" type="button">调试模式</button>
        </div>
      </header>

      <section class="main-grid">
        <aside class="side-panel">
          <div class="card lift-card">
            <div class="card-header">
              <h2>升降控制</h2>
              <span class="chip" id="lift-status">已停止</span>
            </div>
            <div class="lift-controls">
              <button class="btn lift-up" id="lift-up" type="button">升高</button>
              <button class="btn lift-down" id="lift-down" type="button">下降</button>
              <button class="btn lift-stop" id="lift-stop" type="button">停止</button>
            </div>
          </div>

          <div class="card heater-card">
            <div class="card-header">
              <h2>加热控制</h2>
              <span class="chip" id="heater-status">
                {% if heater.configured %}
                状态：<span data-role="heater-text">{{ "开启" if heater.on else "关闭" }}</span>
                {% else %}
                状态：未配置
                {% endif %}
              </span>
            </div>
            <button
              class="btn heater-toggle"
              id="heater-toggle"
              type="button"
              {% if not heater.configured %}disabled{% endif %}
            >
              {{ "停止加热" if heater.on else "开始加热" }}
            </button>
          </div>
        </aside>

        <section class="card process-panel">
          <div class="card-header">
            <h2>工艺流向</h2>
            <span class="chip">实时监控</span>
          </div>
          <div class="tank-zone">
            <div class="tank-block soak" style="--level: {{ tank_levels.soak }}; --liquid-base: {{ tank_colors.soak[0] }} {{ tank_colors.soak[1] }} {{ tank_colors.soak[2] }}">
              <div class="tank-shell">
                <div class="lift-rail" aria-hidden="true">
                  <div class="lift-carriage">
                    <div class="lift-indicator" id="lift-indicator">
                      <div class="arrow up"></div>
                      <div class="arrow down"></div>
                    </div>
                  </div>
                </div>
                <div class="tank-percent">{{ tank_levels.soak }}%</div>
                <div class="tank-metrics">
                  <span>温度 {{ "%.1f"|format(tank_temps.soak) }}°C</span>
                  <span>pH {{ "%.2f"|format(tank_phs.soak) }}</span>
                </div>
                <div class="tank-liquid">
                  <div class="surface"></div>
                  <div class="surface two"></div>
                </div>
              </div>
              <div class="tank-label">浸泡桶</div>
            </div>

            <div class="pipe-stack" aria-hidden="true">
              <div class="pipe-group fresh">
                <div class="pipe to-right" data-pipe="0"><div class="pipe-flow"></div></div>
                <div class="pipe to-left" data-pipe="1"><div class="pipe-flow"></div></div>
              </div>
              <div class="pipe-group heat">
                <div class="pipe to-right" data-pipe="2"><div class="pipe-flow"></div></div>
                <div class="pipe to-left" data-pipe="3"><div class="pipe-flow"></div></div>
              </div>
            </div>

            <div class="tank-column">
              <div class="tank-block small fresh" style="--level: {{ tank_levels.fresh }}; --liquid-base: {{ tank_colors.fresh[0] }} {{ tank_colors.fresh[1] }} {{ tank_colors.fresh[2] }}">
                <div class="tank-shell">
                  <div class="tank-percent">{{ tank_levels.fresh }}%</div>
                  <div class="tank-metrics">
                    <span>温度 {{ "%.1f"|format(tank_temps.fresh) }}°C</span>
                    <span>pH {{ "%.2f"|format(tank_phs.fresh) }}</span>
                  </div>
                  <div class="tank-liquid">
                    <div class="surface"></div>
                    <div class="surface two"></div>
                  </div>
                </div>
                <div class="tank-label">清水桶</div>
              </div>
              <div class="tank-block small heat" style="--level: {{ tank_levels.heat }}; --liquid-base: {{ tank_colors.heat[0] }} {{ tank_colors.heat[1] }} {{ tank_colors.heat[2] }}">
                <div class="tank-shell">
                  <div class="tank-percent">{{ tank_levels.heat }}%</div>
                  <div class="tank-metrics">
                    <span>温度 {{ "%.1f"|format(tank_temps.heat) }}°C</span>
                    <span>pH {{ "%.2f"|format(tank_phs.heat) }}</span>
                  </div>
                  <div class="tank-liquid">
                    <div class="surface"></div>
                    <div class="surface two"></div>
                  </div>
                </div>
                <div class="tank-label">加热桶</div>
              </div>
            </div>
          </div>
        </section>
      </section>

      <section class="control-grid" id="grid">
        {% for pump in pumps %}
        {% if pump.index < 2 %}
        <article
          class="pump-card{% if pump.on %} on{% endif %}"
          data-kind="pump"
          data-index="{{ pump.index }}"
          data-on="{{ "1" if pump.on else "0" }}"
        >
          <div class="pump-head">
            <div class="pump-icon" aria-hidden="true">
              <div class="pump-shell"></div>
              <div class="pump-center"></div>
              <div class="pump-spout"></div>
              <div class="water"></div>
            </div>
            <div class="pump-info">
              <h3>{{ pump.index + 1 }}号水泵</h3>
              <p>{{ routes[pump.index] if pump.index < routes | length else "未配置" }}</p>
              <span class="mono">GPIO {{ pump.pin }}</span>
            </div>
          </div>
          <div class="status">
            <span class="dot" data-role="dot"></span>
            <span class="status-text" data-role="status">关闭</span>
          </div>
          <button class="btn toggle" data-role="toggle" type="button">打开</button>
        </article>
        {% endif %}
        {% endfor %}

        <article
          class="pump-card{% if pump3 and pump3.on %} on{% endif %}"
          data-kind="pump"
          data-index="2"
          data-on="{{ "1" if pump3 and pump3.on else "0" }}"
        >
          <div class="pump-head">
            <div class="pump-icon" aria-hidden="true">
              <div class="pump-shell"></div>
              <div class="pump-center"></div>
              <div class="pump-spout"></div>
              <div class="water"></div>
            </div>
            <div class="pump-info">
              <h3>3号水泵</h3>
              <p>浸泡桶 → 自动阀</p>
              {% if pump3 %}
              <span class="mono">GPIO {{ pump3.pin }}</span>
              {% endif %}
            </div>
          </div>
          <div class="status">
            <span class="dot" data-role="dot"></span>
            <span class="status-text" data-role="status">关闭</span>
          </div>
          <button class="btn toggle" data-role="toggle" type="button">打开</button>
          <div class="auto-switches">
            <div class="auto-row" data-auto="fresh" data-on="{{ "1" if auto_switches.fresh else "0" }}">
              <div class="auto-text">
                <strong>开关1</strong>
                <span>浸泡桶 → 清水桶</span>
              </div>
              <button class="btn toggle auto" data-auto="fresh" type="button">打开</button>
            </div>
            <div class="auto-row" data-auto="heat" data-on="{{ "1" if auto_switches.heat else "0" }}">
              <div class="auto-text">
                <strong>开关2</strong>
                <span>浸泡桶 → 加热桶</span>
              </div>
              <button class="btn toggle auto" data-auto="heat" type="button">打开</button>
            </div>
          </div>
        </article>
      </section>

      <footer class="status-bar">
        <span id="hint">就绪。</span>
      </footer>
    </div>

    <script>
      const pumpCards = Array.from(document.querySelectorAll('.pump-card[data-kind="pump"]'));
      const pump3Card = document.querySelector('.pump-card[data-index="2"]');
      const autoRows = Array.from(document.querySelectorAll(".auto-row"));
      const hint = document.getElementById("hint");
      const pipes = new Map(
        Array.from(document.querySelectorAll(".pipe")).map((pipe) => [
          pipe.dataset.pipe,
          pipe,
        ])
      );
      const liftIndicator = document.getElementById("lift-indicator");
      const liftStatus = document.getElementById("lift-status");
      const liftUp = document.getElementById("lift-up");
      const liftDown = document.getElementById("lift-down");
      const liftStop = document.getElementById("lift-stop");
      const debugToggle = document.getElementById("debug-toggle");
      const heaterToggle = document.getElementById("heater-toggle");
      const heaterText = document.querySelector('[data-role="heater-text"]');

      function setPipeFlow(index, on) {
        const pipe = pipes.get(String(index));
        if (pipe) {
          pipe.classList.toggle("on", on);
        }
      }

      function setPumpStatus(card, on) {
        const dot = card.querySelector('[data-role="dot"]');
        const label = card.querySelector('[data-role="status"]');
        const toggle = card.querySelector('[data-role="toggle"]');
        label.textContent = on ? "开启" : "关闭";
        dot.classList.toggle("on", on);
        dot.classList.toggle("off", !on);
        card.classList.toggle("on", on);
        card.dataset.on = on ? "1" : "0";
        toggle.textContent = on ? "关闭" : "打开";
        toggle.classList.toggle("on", !on);
        toggle.classList.toggle("off", on);
        const index = Number(card.dataset.index);
        if (index === 0) {
          setPipeFlow(0, on);
        } else if (index === 1) {
          setPipeFlow(2, on);
        }
      }

      function setLiftState(state) {
        liftIndicator.classList.toggle("up", state === "up");
        liftIndicator.classList.toggle("down", state === "down");
        liftIndicator.classList.toggle("idle", state === "stop");
        if (state === "up") {
          liftStatus.textContent = "正在抬起";
        } else if (state === "down") {
          liftStatus.textContent = "正在降低";
        } else {
          liftStatus.textContent = "已停止";
        }
      }

      function setCardBusy(card, busy) {
        if (!card) return;
        card.querySelectorAll("button").forEach((btn) => {
          btn.disabled = busy;
        });
      }

      function setAutoRow(row, on) {
        row.dataset.on = on ? "1" : "0";
        const btn = row.querySelector("button");
        if (btn) {
          btn.textContent = on ? "关闭" : "打开";
          btn.classList.toggle("on", !on);
          btn.classList.toggle("off", on);
        }
      }

      function updateValveFlows(pumpOn) {
        autoRows.forEach((row) => {
          const which = row.dataset.auto;
          const active = row.dataset.on === "1" && pumpOn;
          if (which === "fresh") {
            setPipeFlow(1, active);
          } else if (which === "heat") {
            setPipeFlow(3, active);
          }
        });
      }

      async function refreshStatus() {
        try {
          const res = await fetch("/api/status");
          const data = await res.json();
          const relayMap = new Map((data.relays || []).map((item) => [String(item.index), item]));
          pumpCards.forEach((card) => {
            const item = relayMap.get(card.dataset.index);
            if (item) {
              setPumpStatus(card, Boolean(item.on));
            }
          });
          if (data.relays && data.relays[2]) {
            setPumpStatus(pump3Card, Boolean(data.relays[2].on));
          }
          if (data.auto) {
            autoRows.forEach((row) => {
              const which = row.dataset.auto;
              setAutoRow(row, Boolean(data.auto[which]));
            });
          }
          if (data.heater && heaterToggle && heaterText) {
            const configured = Boolean(data.heater.configured);
            heaterToggle.disabled = !configured;
            if (configured) {
              const on = Boolean(data.heater.on);
              heaterText.textContent = on ? "开启" : "关闭";
              heaterToggle.textContent = on ? "停止加热" : "开始加热";
              heaterToggle.classList.toggle("on", !on);
              heaterToggle.classList.toggle("off", on);
            }
          }
          updateValveFlows(pump3Card?.dataset.on === "1");
          hint.textContent = "Last update: " + new Date().toLocaleTimeString();
        } catch (err) {
          hint.textContent = "Status unavailable.";
        }
      }

      async function setRelay(card, on) {
        setCardBusy(card, true);
        hint.textContent = on ? "正在开启..." : "正在关闭...";
        const index = Number(card.dataset.index);
        try {
          const res = await fetch("/api/relay", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ index, on }),
          });
          const data = await res.json();
          setPumpStatus(card, Boolean(data.on));
          hint.textContent = data.on ? "水泵已开启。" : "水泵已关闭。";
        } catch (err) {
          hint.textContent = "指令失败。";
        } finally {
          setCardBusy(card, false);
        }
      }

      async function setAutoSwitch(row, on) {
        setCardBusy(pump3Card, true);
        hint.textContent = on ? "正在开启..." : "正在关闭...";
        const which = row.dataset.auto;
        try {
          const res = await fetch("/api/auto", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ which, on }),
          });
          const data = await res.json();
          if (data.auto) {
            autoRows.forEach((r) => {
              const key = r.dataset.auto;
              setAutoRow(r, Boolean(data.auto[key]));
            });
          }
          updateValveFlows(pump3Card?.dataset.on === "1");
          hint.textContent = "阀门状态已更新。";
        } catch (err) {
          hint.textContent = "指令失败。";
        } finally {
          setCardBusy(pump3Card, false);
        }
      }

      pumpCards.forEach((card) => {
        const toggle = card.querySelector('[data-role="toggle"]');
        toggle.addEventListener("click", () => {
          const nextOn = card.dataset.on !== "1";
          setRelay(card, nextOn);
        });
        setPumpStatus(card, card.dataset.on === "1");
      });

      autoRows.forEach((row) => {
        const btn = row.querySelector("button");
        btn.addEventListener("click", () => {
          const nextOn = row.dataset.on !== "1";
          setAutoSwitch(row, nextOn);
        });
        setAutoRow(row, row.dataset.on === "1");
      });

      if (pump3Card) {
        setPumpStatus(pump3Card, pump3Card.dataset.on === "1");
      }
      updateValveFlows(pump3Card?.dataset.on === "1");

      liftUp.addEventListener("click", () => setLiftState("up"));
      liftDown.addEventListener("click", () => setLiftState("down"));
      liftStop.addEventListener("click", () => setLiftState("stop"));
      setLiftState("stop");

      debugToggle.addEventListener("click", () => {
        document.body.classList.toggle("debug");
        debugToggle.classList.toggle("active");
      });

      if (heaterToggle) {
        heaterToggle.addEventListener("click", async () => {
          if (heaterToggle.disabled) return;
          const nextOn = heaterText?.textContent !== "开启";
          try {
            const res = await fetch("/api/heater", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ on: nextOn }),
            });
            const data = await res.json();
            if (data.configured && heaterText) {
              const on = Boolean(data.on);
              heaterText.textContent = on ? "开启" : "关闭";
              heaterToggle.textContent = on ? "停止加热" : "开始加热";
            }
          } catch (err) {
            hint.textContent = "指令失败。";
          }
        });
      }

      refreshStatus();
      setInterval(refreshStatus, 1000);
    </script>
  </body>
</html>
