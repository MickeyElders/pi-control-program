<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Water Pump Control</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <main class="stage">
      <section class="panel" aria-live="polite">
        <header class="panel-header">
          <div>
            <p class="eyebrow">Relay Deck</p>
            <h1>Water Pump Control</h1>
          </div>
          <div class="meta">
            <div class="meta-row">
              Active low: <span class="mono">{{ "true" if active_low else "false" }}</span>
            </div>
            <div class="meta-row">
              Pins: <span class="mono">{{ pins | join(", ") }}</span>
            </div>
          </div>
        </header>

        <div class="grid" id="grid">
          {% for pump in pumps %}
          <article
            class="pump-card{% if pump.on %} on{% endif %}"
            data-index="{{ pump.index }}"
            data-on="{{ "1" if pump.on else "0" }}"
          >
            <div class="pump-top">
              <div class="pump-icon" aria-hidden="true">
                <div class="pump-shell"></div>
                <div class="pump-center"></div>
                <div class="pump-spout"></div>
                <div class="water"></div>
              </div>
              <div class="pump-label">
                <h2>Pump {{ pump.index + 1 }}</h2>
                <p>GPIO <span class="mono">{{ pump.pin }}</span></p>
              </div>
            </div>

            <div class="status">
              <span class="dot" data-role="dot"></span>
              <span class="status-text" data-role="status">Off</span>
            </div>

            <div class="controls">
              <button class="btn on" data-action="on" type="button">On</button>
              <button class="btn off" data-action="off" type="button">Off</button>
            </div>
          </article>
          {% endfor %}
        </div>

        <p class="hint" id="hint">Ready.</p>
      </section>
    </main>

    <script>
      const cards = Array.from(document.querySelectorAll(".pump-card"));
      const hint = document.getElementById("hint");

      function setCardStatus(card, on) {
        const dot = card.querySelector('[data-role="dot"]');
        const label = card.querySelector('[data-role="status"]');
        label.textContent = on ? "On" : "Off";
        dot.classList.toggle("on", on);
        dot.classList.toggle("off", !on);
        card.classList.toggle("on", on);
      }

      function setCardBusy(card, busy) {
        card.querySelectorAll("button").forEach((btn) => {
          btn.disabled = busy;
        });
      }

      async function refreshStatus() {
        try {
          const res = await fetch("/api/status");
          const data = await res.json();
          const relayMap = new Map(
            (data.relays || []).map((item) => [String(item.index), item])
          );
          cards.forEach((card) => {
            const item = relayMap.get(card.dataset.index);
            if (item) {
              setCardStatus(card, Boolean(item.on));
            }
          });
          hint.textContent = "Last update: " + new Date().toLocaleTimeString();
        } catch (err) {
          hint.textContent = "Status unavailable.";
        }
      }

      async function setRelay(card, on) {
        setCardBusy(card, true);
        hint.textContent = on ? "Turning on..." : "Turning off...";
        const index = Number(card.dataset.index);
        try {
          const res = await fetch("/api/relay", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ index, on }),
          });
          const data = await res.json();
          setCardStatus(card, Boolean(data.on));
          hint.textContent = data.on ? "Pump is on." : "Pump is off.";
        } catch (err) {
          hint.textContent = "Command failed.";
        } finally {
          setCardBusy(card, false);
        }
      }

      cards.forEach((card) => {
        const onBtn = card.querySelector('[data-action="on"]');
        const offBtn = card.querySelector('[data-action="off"]');
        onBtn.addEventListener("click", () => setRelay(card, true));
        offBtn.addEventListener("click", () => setRelay(card, false));
        setCardStatus(card, card.dataset.on === "1");
      });

      refreshStatus();
      setInterval(refreshStatus, 5000);
    </script>
  </body>
</html>
